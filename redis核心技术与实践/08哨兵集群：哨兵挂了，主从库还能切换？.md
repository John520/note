# 哨兵集群
## 如何构建哨兵集群？
* 哨兵与主库建立pub/sub 方式，其他哨兵通过频道，发现新加入的节点，并与其建立连接

## 如何与从库建立连接？
* 哨兵发送`Info`命令个主库，获取从库信息，并分别与从库建立连接

## 如何判断主库下线？
* 当主库长时间没有响应哨兵，那么哨兵将其判定为`主观下线`
* 哨兵将询问其他哨兵主库的状态，若大于等于配置数量的哨兵认为其`主观下线`，则其状态将变成`客观下线`
* 该哨兵将发起选举为哨兵leader,若成功当选，将负责主备切换，并通知客户端

## 如何选举哨兵leader?
* `currentEpoch`递增，同时向其他哨兵发起投票，若其他哨兵在本次`Epoch`内没有将票投出去，那么将依据先到先得的方式投票
* 获得半数以上的选票，那么该哨兵将成为本次`Epoch`的leader

## 哨兵leader如何进行主备切换？
* 首先过滤已经断线的从库和经常经常断线的从库
* 按照优先级排序，有优先级高的直接胜出
* 按照复制进度越快的胜出
* 按照runid越小的胜出

## 如何通知客户端？
* 哨兵会建立很多pub/sub 频道，其中有个主备切换的频道，客户端订阅该频道即可获得相应的通知事件